- name: Deploy stack from a compose file
  become: yes
  community.docker.docker_stack:
    state: present
    name: "{{couchdb_stack_name}}"
    compose:
      - "{{ couchdb_dir }}/docker-compose.yaml"

- name: Get info from a service
  become: yes
  community.docker.docker_swarm_service_info:
    name: "{{couchdb_stack_name}}_{{couchdb_service_name}}"
  register: result

- name: Wait for database to be available
  shell: curl http://{{ couchdb_user }}:{{ couchdb_pass }}@127.0.0.1:5984
  register: result
  until: result.stderr.find("Connection refused") == -1
  retries: 20
  delay: 30

